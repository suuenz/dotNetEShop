trigger:
- main

variables:
  dockerRegistryServiceConnection: 'eshopweb2025'  # اسم سرویس‌کانکشن شما به ACR
  imageRepository1: 'eshopwebmvc'
  imageRepository2: 'eshoppublicapi'
  containerRegistry: 'eshopweb2025.azurecr.io'
  tag: '$(Build.BuildId)'

pool:
  vmImage: 'ubuntu-latest'

steps:

- task: DockerInstaller@0
  inputs:
    dockerVersion: 'latest'

# لاگین به ACR
- task: Docker@2
  displayName: 'Login to ACR'
  inputs:
    command: 'login'
    containerRegistry: '$(dockerRegistryServiceConnection)'

# بیلد image اول
- task: Docker@2
  displayName: 'Build eshopwebmvc'
  inputs:
    command: 'build'
    dockerfile: 'src/Web/Dockerfile'
    tags: |
      $(tag)
    repository: $(imageRepository1)
    containerRegistry: '$(dockerRegistryServiceConnection)'

# بیلد image دوم
- task: Docker@2
  displayName: 'Build eshoppublicapi'
  inputs:
    command: 'build'
    dockerfile: 'src/PublicApi/Dockerfile'
    tags: |
      $(tag)
    repository: $(imageRepository2)
    containerRegistry: '$(dockerRegistryServiceConnection)'

# پوش image اول
- task: Docker@2
  displayName: 'Push eshopwebmvc'
  inputs:
    command: 'push'
    repository: $(imageRepository1)
    tags: |
      $(tag)
    containerRegistry: '$(dockerRegistryServiceConnection)'

# پوش image دوم
- task: Docker@2
  displayName: 'Push eshoppublicapi'
  inputs:
    command: 'push'
    repository: $(imageRepository2)
    tags: |
      $(tag)
    containerRegistry: '$(dockerRegistryServiceConnection)'